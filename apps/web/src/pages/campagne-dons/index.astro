---
// ğŸ§± Components
import CheckoutFormWrapper from "./_components/CheckoutFormWrapper";
import ProgressBar from "./_components/ProgressBar";
import TitlePullUp from "./_components/TitlePullUp";
import Meteors from "./_components/Meteors";
import MarqueeDemo from "./_components/MarqueeDemo";
import { Image } from "astro:assets";

// ğŸ–¼ï¸ Layout
import BaseLayout from "@web/layout/BaseLayout/BaseLayout.astro";
import PageLayout from "@web/layout/PageLayout/PageLayout.astro";

// ğŸ”§ Libs
import { stripe } from "@/data-access/stripe";
// import puppeteer from "puppeteer";

// ğŸ¨ Assets

import TipeeeLogo from "./_assets/tipeee.png";
import SemaineType from "./_assets/semaine-type.jpg";
import CoverCampaign from "./_assets/cover-campaign.jpg";
import BottomPageIllu from "./_assets/bottom-page.webp";

// export const prerender = false;
Astro.response.headers.set(
  "Cache-Control",
  "s-maxage=3600, stale-while-revalidate",
);

let totalTipeee = 0;
let reviews: any = [];

// Tipeee comments and total
// const browser = await puppeteer.launch({
//   headless: true,
//   defaultViewport: null,
// });

// const page = await browser.newPage();

// await page.goto(
//   "https://fr.tipeee.com/aidez-nous-a-continuer-en-mieux/comments",
//   {
//     waitUntil: "domcontentloaded",
//   },
// );

// await page.waitForSelector(".p-comm-inner");

// const totalHandle = await page.$(
//   ".p-results-panel .p-result-item .p-value span",
// );
// if (totalHandle) {
//   totalTipeee = await totalHandle.evaluate((el: any) =>
//     el.textContent.trim()?.replace(/\s/g, "")?.match(/\d+/)?.at(0),
//   );
// }

// const reviewsHandle = await page.$$(".p-comm-inner");
// reviews = await Promise.all(
//   reviewsHandle.map(async (review) =>
//     review.evaluate((el) => {
//       const name = el?.querySelector(".p-c-author a")?.innerText;
//       const date = el
//         ?.querySelector(".p-c-metas")
//         ?.innerText.match(/\d+.+/)
//         .at(0);
//       const imgTag = el?.querySelector(".p-comm-heading a") as HTMLElement;

//       const img = getComputedStyle(imgTag)
//         .backgroundImage.match(/https[^"]*/)
//         ?.at(0);

//       const body = el?.querySelector(".p-c-content")?.innerText;

//       return { name, date, body, img };
//     }),
//   ),
// );

// Compute percent in progress for campaign
if (totalTipeee === 0) totalTipeee = 11141;

let transactions: any[] = [];
let has_more;
let next_page;
do {
  try {
    const resTransactions = (await stripe.charges.search({
      query: `metadata['campaign']:'dons-fin-2024' AND created>${new Date("2024-11-07").getTime() / 1000}`,
      limit: 100,
      ...(next_page ? { page: next_page } : {}),
    })) as any;
    next_page = resTransactions.next_page;
    has_more = resTransactions.has_more;
    if (has_more) next_page = resTransactions.next_page;
    transactions = [...transactions, ...resTransactions.data];
  } catch (e) {
    console.error("Error while fetching transactions for campaign", e);
  }
} while (has_more);
const totalSite = transactions.reduce((acc, cv) => acc + cv.amount / 100, 0);
const MIN_VALUE = 5;
const progressInPercent = Math.max(
  Math.floor(((totalSite + +totalTipeee) / 40000) * 100),
  MIN_VALUE,
);
---

<BaseLayout
  title="Aidez Frustration Magazine Ã  grandir !"
  displayBanner={false}>
  <PageLayout>
    <!-- ğŸ–¼ï¸ Cover -->
    <Image
      src={CoverCampaign}
      class="mx-auto mb-16"
      width="800"
      alt="Une semaine type de publications sur <i>Frustration</i> Magazine pour notre prochain rÃ©organisation"
    />
    <div
      class="relative flex h-[200px] w-full flex-col items-center justify-center overflow-hidden bg-background">
      <Meteors
        client:load
        number={20}
      />
      <!-- ğŸ…°ï¸ Titles -->
      <TitlePullUp
        client:load
        words="On a besoin de vous pour continuer !"
        className="z-10 text-4xl md:text-5xl text-black lg:text-7xl text-pretty text-center font-bold uppercase font-bakbak"
      />
    </div>
    <!-- === Progress bar -->
    <ProgressBar
      client:load
      value={progressInPercent}
      delayInSeconds={2}
      background="bg-yellow"
      className="h-10 mt-12 shadow-lg"
    />
    <!-- ğŸ”  Text -->
    <article class="mt-12 font-open-sans tracking-wide md:text-lg">
      <p class="mb-11">
        <i>Frustration</i> a fait dâ€™Ã©normes progrÃ¨s cette annÃ©e, <b
          >mais notre modÃ¨le Ã©conomique nâ€™est plus viable sur le long terme</b
        >. Nous sommes une Ã©quipe de 2,5 personnes, sans local, et malgrÃ© notre
        succÃ¨s croissant, <b>la charge de travail dÃ©passe nos capacitÃ©s</b>.
        Pour continuer Ã  produire un journalisme libre et de qualitÃ©, <b
          >nous avons besoin de votre soutien pour publier quotidiennement</b
        >, dÃ©velopper notre partie vidÃ©o, et offrir une vraie sÃ©curitÃ© Ã  notre
        Ã©quipe. Votre aide est essentielle pour que <i><i>Frustration</i></i>
        <b>devienne un mÃ©dia stable tout en restant indÃ©pendant</b>.
      </p>
      <section class="mb-10">
        <h3 class="title-to-highlight w-fit font-bold text-3xl mb-6">
          Pour rÃ©sumer
        </h3>
        <ul class="space-y-3 pl-3 list-decimal">
          <li>
            <b><i>Frustration</i> a rÃ©alisÃ© de gros progrÃ¨s</b> : doublement de la
            frÃ©quentation du site, meilleure visibilitÃ© mÃ©diatique, forte progression
            sur les rÃ©seaux sociaux, augmentation de la production d'articles et
            de vidÃ©os, et une version papier ambitieuse.
          </li>
          <li>
            <b>Mais notre modÃ¨le Ã©conomique nâ€™est plus viable</b> : une Ã©quipe de
            seulement 2,5 personnes avec peu de moyens et une charge de travail exponentielle.
          </li>
          <li>
            <b>Nos dÃ©fis quotidiens</b> : gestion des mails, rÃ©seaux sociaux, correction
            dâ€™articles, production vidÃ©o, comptabilitÃ©, logistique des dons, etc.
          </li>
        </ul>
      </section>
      <section class="mb-10">
        <h3 class="title-to-highlight w-fit font-bold text-3xl mb-6">
          Nos objectifs Ã  court terme
        </h3>
        <ul class="space-y-3 pl-3 list-disc">
          <li>
            <b>Publier quotidiennement</b> pour rivaliser avec les mÃ©dias installÃ©s.
          </li>
          <li>
            <b>Devenir un vrai mÃ©dia vidÃ©o</b> avec des formats longs et rÃ©guliers,
            en plus de lâ€™Ã©crit.
          </li>
          <li>
            <b>Assurer une sÃ©curitÃ© professionnelle</b> en passant de statuts prÃ©caires
            Ã  une Ã©quipe de 3 salariÃ©s en CDI Ã  temps plein.
          </li>
        </ul>
      </section>
      <p class="text-center text-2xl">
        <b>Votre soutien est essentiel</b> : votre aide permet de renforcer notre
        indÃ©pendance et dâ€™assurer la pÃ©rennitÃ© du mÃ©dia sans publicitÃ© ni subventions.
      </p>

      <Image
        src={SemaineType}
        class="mx-auto my-8"
        width="800"
        alt="Une semaine type de publications sur <i>Frustration</i> Magazine pour notre prochain rÃ©organisation"
      />
      <h3
        class="title-to-underline w-fit mx-auto uppercase font-bakbak text-center font-bold text-6xl mb-10">
        Comment nous aider ?
      </h3>
      <p class="text-3xl text-center mb-8">En participant Ã  notre Tipeee</p>
      <a
        href="https://fr.tipeee.com/aidez-nous-a-continuer-en-mieux"
        target="_blank">
        <h3 class="text-center text-5xl text-pretty emoji-pendular">ğŸ‘‡</h3>
        <Image
          src={TipeeeLogo}
          class="mx-auto my-8"
          width="200"
          alt="Logo de la plateforme de finance participatif Tipeee"
        />
      </a>
      <MarqueeDemo
        client:load
        reviews={reviews}
      />
      <p
        class="font-bold my-16 text-4xl gap-2 text-center flex items-center justify-center">
        <svg
          width="32"
          height="32"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
          ><path
            fill="currentColor"
            d="M11 22V6.83L2 16v-2.83L13 2v15.17L22 8v2.83z"
          ></path></svg
        >
        <span>OU</span>
        <svg
          width="32"
          height="32"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
          ><path
            fill="currentColor"
            d="M11 22V6.83L2 16v-2.83L13 2v15.17L22 8v2.83z"
          ></path></svg
        >
      </p>

      <CheckoutFormWrapper client:only="react" />

      <section class="mt-24">
        <h3
          id="projets"
          class="w-fit font-bold text-3xl mb-6">
          Notre situation et nos projets
        </h3>
        <div class="space-y-3">
          <p>
            Ces derniers mois, <i>Frustration</i> a rÃ©alisÃ© de <em
              >gros progrÃ¨s</em
            > dans la diffusion de son travail : <em
              >doublement de la frÃ©quentation du site</em
            >, invitations mÃ©dias beaucoup plus rÃ©guliÃ¨res, trÃ¨s grosses
            progressions sur les rÃ©seaux sociaux, augmentation de la production
            dâ€™articles et de vidÃ©os, une version papier de plus en plus
            ambitieuse qui rencontre un certain succÃ¨sâ€¦ Nous sommes trÃ¨s fier-es
            de tout cela.
          </p>
          <p>
            Malheureusement, <i>Frustration</i> fait face Ã  de <em
              >trÃ¨s lourdes difficultÃ©s</em
            >
            et Ã  un <em>dÃ©calage de plus en plus fort</em> entre la charge de travail
            exponentielle que reprÃ©sente son succÃ¨s et la rÃ©alitÃ© matÃ©rielle de notre
            mÃ©dia.
          </p>
          <p>
            Nous ne sommes que <em>2,5 en Ã©quivalent temps plein</em> et nous ne
            disposons dâ€™<em>aucun local</em>. De lâ€™extÃ©rieur on sâ€™imagine
            parfois que lâ€™essentiel du travail dans un mÃ©dia rÃ©side dans
            lâ€™Ã©criture dâ€™articles, dâ€™enquÃªtes et dâ€™entretiens. Cela ne
            reprÃ©sente pourtant, dans les faits, quâ€™une <em
              >part infime du travail</em
            >.
          </p>
          <p>
            Avec cette Ã©quipe <em>extrÃªmement rÃ©duite</em>, nous devons au
            quotidien :
            <em>gÃ©rer les mails des lecteurs</em>, gÃ©rer les nombreux <em
              >rÃ©seaux sociaux</em
            >
            (Facebook, Youtube, Twitter, Mastodon, Threads, TikTok, Instagramâ€¦) et
            crÃ©er des visuels, faire la <em
              >relecture, la correction et la mise en page des articles</em
            >, gÃ©rer et refonder le site (qui nâ€™est plus assez solide par
            rapport Ã  lâ€™afflux de nouveaux internautes), rÃ©aliser des
            newsletters, faire la <em>comptabilitÃ©</em>, gÃ©rer les dons (les
            modules, les demandes de rÃ©siliation ou de modification, les
            centaines dâ€™envois postaux pour les cadeauxâ€¦), faire le <em
              >travail vidÃ©o</em
            > (captation ou rÃ©alisation, montage, Ã©talonnage, mixageâ€¦), rÃ©aliser
            des illustrations, travailler sur la <em
              >production du numÃ©ro annuel</em
            > (recrutement, maquettage, relectures, tournÃ©e promotionnelle qui implique
            de co-organiser des Ã©vÃ¨nementsâ€¦)...
          </p>
          <p>
            Vous le voyez sÃ»rement en filigrane, en plus du paiement de la
            charge de travail, ces activitÃ©s ont un <em>coÃ»t</em> : logiciels, dÃ©placements,
            matÃ©riel vidÃ©o (camÃ©ra, micro, logiciels de montageâ€¦), hÃ©bergement du
            site et divers plugins, frais postaux, matÃ©riel informatique, outil de
            newsletterâ€¦ Nous sommes dâ€™ailleurs encore souvent contraintes et contraints
            dâ€™assumer personnellement une partie de ces <em>coÃ»ts</em>.
          </p>
          <p>
            MÃªme avec toute notre bonne volontÃ©, nous sommes face Ã  des <em
              >limites et des obstacles</em
            > qui nous empÃªchent de devenir le mÃ©dia solide, rÃ©gulier, serein que
            nous aimerions Ãªtre, que beaucoup de nos lectrices et lecteurs aimeraient
            que nous soyons (ou pensent que nous sommes dÃ©jÃ  en raison de lâ€™optimisme
            que nous souhaitons continuer Ã  afficher).
          </p>

          <p>
            Câ€™est pourquoi nous vous sollicitons pour un <em>coup de pouce</em>.
            Notre
            <em>indÃ©pendance</em>, la <em>gratuitÃ© totale</em> de notre site web,
            notre
            <em>refus de la publicitÃ©</em>, de lâ€™argent des millionnaires
            (contrairement Ã  ce quâ€™on sâ€™imagine : des mÃ©dias de gauche y font
            aussi parfois appel) et des subventions, tout cela nâ€™est possible
            quâ€™avec votre <em>soutien</em>. Nous fonctionnons avec un modÃ¨le de
            dons mensuels pour avoir une base fiable chaque mois, que nous
            renforÃ§ons avec des appels Ã  dons uniques pour celles et ceux qui ne
            peuvent pas donner de maniÃ¨re aussi rÃ©guliÃ¨re mais dont lâ€™aide nous
            est aussi prÃ©cieuse.
          </p>

          <p>
            La vente du magazine papier permet de rembourser sa production et
            peut parfois rapporter un peu dâ€™excÃ©dents - qui sont rÃ©injectÃ©s dans
            les dÃ©penses de fonctionnement du mÃ©dia - mais cela est tout Ã  fait
            <em>marginal</em> (moins de 3% des revenus).
          </p>

          <p>
            Câ€™est donc un <em>modÃ¨le de financement original</em> qui repose entiÃ¨rement
            sur la <em>confiance rÃ©ciproque</em> entre notre mÃ©dia, ses lectrices
            et ses lecteurs.
          </p>
        </div>
      </section>
      <section class="mt-12">
        <h3 class="title-to-highlight w-fit font-bold text-3xl mb-6">
          Ã‰tape nÂ°1 : Publier quotidiennement
        </h3>

        <div class="space-y-3">
          <p>
            Notre premier objectif est dâ€™arriver Ã  <em
              >publier tous les jours</em
            >, comme le font les mÃ©dias plus installÃ©s. Vous le comprenez
            aisÃ©ment : avec toutes les tÃ¢ches que nous assurons avec une Ã©quipe
            trÃ¨s rÃ©duite et des moyens financiers faibles, nous ne sommes pas en
            mesure dâ€™Ã©crire autant que nous le voudrions.
          </p>

          <p>
            Avec votre aide, nous pourrions <em
              >fidÃ©liser les contributeurs et contributrices</em
            > qui Ã©crivent dÃ©jÃ  pour <i>Frustration</i>, voire recourir
            davantage Ã  des
            <em>chroniques et des pigistes extÃ©rieurs</em> (que nous souhaitons dâ€™ailleurs
            rÃ©munÃ©rer dÃ©cemment contrairement Ã  des pratiques rÃ©pandues).
          </p>

          <p>
            En termes de contenus, cela nous permettrait Ã©galement dâ€™avoir
            davantage de <em>formats d'enquÃªtes</em>, des articles qui, dans
            leur nature mÃªme, sont beaucoup plus coÃ»teux car impliquent des
            dÃ©placements, du matÃ©rielâ€¦
          </p>
        </div>
      </section>
      <section class="mt-12">
        <h3 class="title-to-highlight w-fit font-bold text-3xl mb-6">
          Ã‰tape nÂ°2 : Devenir un vrai mÃ©dia (en plus de l'Ã©crit)
        </h3>

        <div class="space-y-5">
          <p>
            Une fois la production rÃ©guliÃ¨re dâ€™articles consolidÃ©e, nous voulons
            poursuivre le dÃ©veloppement de notre <em>partie vidÃ©o</em>.
          </p>

          <p>
            Nous avons dÃ©jÃ  commencÃ© Ã  le faire, avec un certain succÃ¨s, avec :

            <ul class="space-y-1 pl-3 list-disc">
              <li>
                Des captations d'Ã©vÃ©nements que nous avons organisÃ©s le
                dÃ©veloppement de trois sÃ©ries de formats vidÃ©o :
                <ul class="pl-5 space-y-2 mt-3">
                  <li>
                    <b>Ã‰tat des lieux</b> - oÃ¹ des membres de lâ€™Ã©quipe reviennent
                    sur lâ€™actualitÃ© chaude du moment
                  </li>
                  <li>
                    <b>Comprendre</b> - un format plus documentaire et factuel qui
                    donne du contexte et de la profondeur sur un sujet en lien avec
                    lâ€™actualitÃ©
                  </li>
                  <li>
                    <b>Rencontres</b> - un Ã©change entre un ou une membre de la rÃ©daction
                    et une ou un invitÃ©
                  </li>
                </ul>
              </li>
              <li>
                La publication plus rÃ©guliÃ¨re de <em>reels</em> sur les rÃ©seaux sociaux
              </li>
              <li>
                La mise en place dâ€™un <em>partenariat</em> avec <i>Le MÃ©dia</i> pour
                lâ€™Ã©mission
                <i>Coup de Griffe</i>
              </li>
            </ul>
          </p>

          <p>
            Nous aimons lâ€™Ã©criture et continuerons dâ€™Ãªtre avant tout un mÃ©dia
            dâ€™articles Ã©crits. Toutefois la moindre vidÃ©o a un <em
              >audimat infiniment supÃ©rieur</em
            > Ã  un article et câ€™est quelque chose que nous voulons prendre en compte
            par souci dâ€™<em>accessibilitÃ© au plus grand nombre</em>. De la mÃªme
            faÃ§on, une <em>chaÃ®ne Twitch</em> ne remplacerait pas notre travail de
            fond mais permettrait de sâ€™adapter aux <em>nouveaux formats</em> et dâ€™avoir
            davantage dâ€™<em>interactions avec nos lectrices et lecteurs</em>,
            dâ€™en faire un vÃ©ritable <em>espace dâ€™Ã©changes</em>.
          </p>
        </div>
      </section>
      <section class="mt-12">
        <h3 class="title-to-highlight w-fit font-bold text-3xl mb-6">
          Ã‰tape nÂ°3 : Offrir une vraie sÃ©curitÃ© professionnelle
        </h3>
        <div class="space-y-3">
          <p>
            Nous sommes <em>cohÃ©rentes et cohÃ©rents</em> : nous dÃ©fendons le droit
            Ã  des <em>bonnes conditions de travail</em> et Ã  des <em
              >salaires dÃ©cents</em
            >, câ€™est donc, naturellement, ce que nous voulons aussi offrir aux
            personnes qui travaillent pour notre magazine.
          </p>
          <p>
            Câ€™est pourquoi nous souhaitons sortir du <em>statut prÃ©caire</em>,
            fait notamment de <em>temps partiel</em>, dans lequel nous nous
            trouvons actuellement, pour avoir <em
              >trois salariÃ©s en CDI Ã  temps complet</em
            >, et si possible avec un <em
              >salaire autour du salaire moyen en France</em
            >.
          </p>
          <p>
            Avoir une <em>Ã©quipe de trois salariÃ©s Ã  temps complet</em> permettrait
            de <em>stabiliser Ã©normÃ©ment le travail</em> au sein de <i
              >Frustration</i
            >.
          </p>
          <p>
            VoilÃ  donc les <em>objectifs que nous nous sommes fixÃ©s</em> et que nous
            avons voulus raisonnables et ce Ã  quoi, concrÃ¨tement, votre aide contribuera.
          </p>
          <p>
            Nous vous <em>remerÃ§ions infiniment</em> pour votre <em
              >soutien prÃ©cieux</em
            > depuis des annÃ©es qui donne du <em>courage</em>, de lâ€™<em
              >espoir</em
            > et de la <em>motivation</em> !
          </p>
        </div>
      </section>
    </article>
    <Image
      src={BottomPageIllu}
      class="mx-auto mt-12 -mb-16"
      width="800"
      alt="Une rangÃ©e de travailleuses et travailleurs"
    />
  </PageLayout>

  <script>
    import { annotate } from "rough-notation";
    const titlesToHighlight = Array.from(
      document.querySelectorAll(".title-to-highlight"),
    ) as HTMLElement[];

    titlesToHighlight.forEach((title) => {
      const annotation = annotate(title, {
        type: "highlight",
        animationDuration: 2000,
        color: "#FFF200",
      });
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              setTimeout(() => {
                annotation.show();
                observer.disconnect();
              }, 1000);
            }
          });
        },
        { threshold: 0.1 },
      );
      observer.observe(title);
    });

    const titlesToUnderline = Array.from(
      document.querySelectorAll(".title-to-underline"),
    ) as HTMLElement[];

    titlesToUnderline.forEach((title) => {
      const annotation = annotate(title, {
        type: "underline",
        iterations: 3,
        strokeWidth: 3,
        animationDuration: 2000,
        color: "black",
      });
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              setTimeout(() => {
                annotation.show();
                observer.disconnect();
              }, 1000);
            }
          });
        },
        { threshold: 0.1 },
      );
      observer.observe(title);
    });
  </script>
  <style>
    @counter-style results-counter {
      system: cyclic;
      symbols: "âœŒï¸" "ğŸ“ˆ" "ğŸ“¨" "ğŸ‘©â€ğŸ¤";
      suffix: "  ";
    }

    @counter-style achievements-counter {
      system: cyclic;
      symbols: "ğŸ–‹ï¸" "ğŸ¥" "#ï¸âƒ£" "ğŸ¤" "ğŸ§›" "ğŸ—¯ï¸" "ğŸ™…â€â™‚ï¸" "ğŸ‘Š";
      suffix: "  ";
    }

    @counter-style projects-counter {
      system: cyclic;
      symbols: "ğŸ¨" "ğŸ‘¯" "ğŸŒ" "ğŸ¤" "ğŸ¶";
      suffix: "  ";
    }
    @keyframes pendular {
      0%,
      100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    em {
      font-weight: bold;
      font-style: normal;
    }

    .emoji-pendular {
      animation: pendular 2s ease-in-out infinite;
    }

    .list-achievements {
      list-style: achievements-counter;
    }

    .list-results {
      list-style: results-counter;
    }

    .list-projects {
      list-style: projects-counter;
    }
  </style>
</BaseLayout>
